<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <base target="_self">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SN Guinchos - Gestão Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SN Guinchos">
    <link rel="apple-touch-icon" href="icon-512.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: "#000000", secondary: "#374151", success: "#10b981", warning: "#f59e0b", danger: "#ef4444", dark: "#1f2937", light: "#f9fafb" },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        @media print {
            /* Força a exibição de TUDO no PDF, ignorando o estado das abas */
            body, html { height: auto !important; overflow: visible !important; }
            .no-print, header, nav, form, button, #loading-overlay, #area-filtros { display: none !important; }
            .content-section { display: block !important; opacity: 1 !important; visibility: visible !important; position: relative !important; }
            #section-dashboard, #section-manutencao, #section-viagens, #section-abastecimentos, #section-despesas { display: block !important; }
            
            /* Ajustes de Layout para Papel */
            .bg-white { border: 1px solid #ddd !important; box-shadow: none !important; margin-bottom: 15px !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            #print-header-info { display: block !important; border-bottom: 3px solid #000 !important; padding-bottom: 10px; margin-bottom: 20px; }
            table { width: 100% !important; border-collapse: collapse !important; }
            th, td { border: 1px solid #eee !important; padding: 8px !important; }
            #dash-lucro { color: #16a34a !important; font-size: 24pt !important; font-weight: bold !important; }
        }
        
        /* Estilos de tela */
        .input-padrao { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 8px; outline: none; background: #fff; }
        .btn-primary { background-color: #000000; color: white; font-weight: bold; padding: 12px; border-radius: 8px; cursor: pointer; width: 100%; }
        .btn-delete { color: #ef4444; padding: 10px; cursor: pointer; }
        .checkbox-label { display: inline-flex; align-items: center; cursor: pointer; padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 20px; background: white; font-size: 0.85rem; margin-right: 5px; margin-bottom: 5px; }
        .checkbox-label.checked { background-color: #e5e7eb; border-color: #000000; color: #000000; font-weight: bold; }
        .row-clicavel { cursor: pointer; }
        #print-header-info { display: none; }
        .card-alerta { border-left: 6px solid transparent; }
        .vencido { background-color: #fee2e2; border-left-color: #ef4444; }
        .atencao { background-color: #fef3c7; border-left-color: #f59e0b; }
        .ok { background-color: #dcfce7; border-left-color: #22c55e; }
    </style>
</head>
<body class="min-h-screen bg-gray-50 font-sans">
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-primary"></div>
        <p class="mt-4 text-primary font-bold" id="loading-text">Processando...</p>
    </div>

    <div id="modal-viagem" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden no-print p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden">
            <div id="modal-conteudo" class="p-6"></div>
            <button onclick="fecharModal()" class="w-full bg-gray-200 py-4 font-bold uppercase">Fechar</button>
        </div>
    </div>

    <header class="bg-primary text-white shadow-lg sticky top-0 z-20 no-print">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <h1 class="text-xl font-bold">SN Guinchos</h1>
            <div class="flex space-x-2">
                <button onclick="window.print()" class="bg-green-600 px-3 py-2 rounded-lg font-bold">PDF</button>
                <button onclick="carregarDadosDoGoogle()" class="bg-white text-black px-3 py-2 rounded-lg font-bold"><i class="fas fa-sync-alt"></i></button>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-md no-print overflow-x-auto">
        <div class="container mx-auto px-4 flex space-x-4 py-3 min-w-max">
            <button onclick="mudarAba('dashboard')" class="nav-btn font-bold" id="btn-dashboard">Dashboard</button>
            <button onclick="mudarAba('manutencao')" class="nav-btn" id="btn-manutencao">Manutenção</button>
            <button onclick="mudarAba('viagens')" class="nav-btn" id="btn-viagens">Viagens</button>
            <button onclick="mudarAba('abastecimentos')" class="nav-btn" id="btn-abastecimentos">Abastec.</button>
            <button onclick="mudarAba('despesas')" class="nav-btn" id="btn-despesas">Despesas</button>
            <button onclick="mudarAba('veiculos')" class="nav-btn" id="btn-veiculos">Veículos</button>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-6">
        <div id="print-header-info">
            <h1 class="text-2xl font-bold">SN Guinchos - Relatório Geral</h1>
            <p id="txt-filtro-vans"></p>
        </div>

        <div id="area-filtros" class="mb-6 bg-white p-4 rounded-xl shadow no-print">
            <select id="filtro-periodo" onchange="renderizarTudo()" class="p-2 border rounded-lg w-full mb-4">
                <option value="todos">Todo o Período</option>
                <option value="7">7 dias</option>
                <option value="30">30 dias</option>
            </select>
            <div id="container-checkboxes" class="flex flex-wrap"></div>
        </div>

        <section id="section-dashboard" class="content-section">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-black">
                    <p class="text-xs font-bold text-gray-500">KM TOTAL</p>
                    <h3 id="dash-km" class="text-xl font-bold">0 km</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-green-500">
                    <p class="text-xs font-bold text-gray-500">FATURAMENTO</p>
                    <h3 id="dash-faturamento" class="text-xl font-bold text-green-600">R$ 0,00</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-red-500">
                    <p class="text-xs font-bold text-gray-500">combustível</p>
                    <h3 id="dash-estimado-oleo" class="text-xl font-bold text-red-600">R$ 0,00</h3>
                </div>
                <div class="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500">
                    <p class="text-xs font-bold text-gray-500">DESPESAS</p>
                    <h3 id="dash-despesas" class="text-xl font-bold text-yellow-600">R$ 0,00</h3>
                </div>
            </div>
            <div class="bg-black p-6 rounded-xl text-white mb-6">
                <p class="text-xs font-bold text-gray-400">LUCRO LÍQUIDO</p>
                <h2 id="dash-lucro" class="text-4xl font-bold text-green-400">R$ 0,00</h2>
            </div>
        </section>

        <section id="section-manutencao" class="content-section hidden">
            <h2 class="font-bold mb-4">Manutenção</h2>
            <div id="painel-alertas" class="grid gap-4 mb-6"></div>
            <div id="lista-manutencao" class="space-y-2"></div>
        </section>

        <section id="section-viagens" class="content-section hidden">
            <h2 class="font-bold mb-4">Histórico de Viagens</h2>
            <div class="bg-white rounded-xl shadow overflow-hidden">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100"><tr><th class="p-3">Data</th><th class="p-3">Veículo/Rota</th><th class="p-3">Valor</th></tr></thead>
                    <tbody id="lista-viagens"></tbody>
                </table>
            </div>
        </section>

        <section id="section-abastecimentos" class="content-section hidden"><div id="lista-abastecimentos"></div></section>
        <section id="section-despesas" class="content-section hidden"><div id="lista-despesas"></div></section>
        <section id="section-veiculos" class="content-section hidden"><div id="lista-veiculos"></div></section>
    </main>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbz6BhO_SsoYGqxeJOi2S9oLzXFSMUe3XWoHv2Y8hLSO2oT824tiGwKcx_b_xRR3v0XEzA/exec";
        let DB = { veiculos: [], viagens: [], abastecimentos: [], despesas: [], manutencao: [] };
        let veiculosSelecionados = [];

        async function carregarDadosDoGoogle() {
            mostrarLoading(true, "Carregando...");
            try {
                const response = await fetch(API_URL);
                DB = await response.json();
                inicializarFiltros();
                renderizarTudo();
            } catch (e) { alert("Falha ao sincronizar."); }
            finally { mostrarLoading(false); }
        }

        function num(v) { 
            if (!v) return 0;
            let n = v.toString().replace("R$", "").replace(/\s/g, "").replace(".", "").replace(",", ".");
            return parseFloat(n) || 0;
        }

        function formatarData(d) { return d ? d.split('T')[0].split('-').reverse().join('/') : ""; }
        function converterParaDataObj(d) { return d ? new Date(d) : new Date(0); }

        function renderizarTudo() {
            const viagens = filtrarLista(DB.viagens || []);
            const abastec = filtrarLista(DB.abastecimentos || []);
            const desp = filtrarLista(DB.despesas || []);
            const manu = filtrarLista(DB.manutencao || []);

            let faturamento = viagens.reduce((a, c) => a + num(c.viagem), 0);
            let km = viagens.reduce((a, c) => a + num(c.km), 0);
            let gastos = desp.reduce((a, c) => a + num(c.valor), 0) + manu.reduce((a, c) => a + num(c.valor), 0) + viagens.reduce((a, c) => a + num(c.motorista), 0);
            let totalAbastec = abastec.reduce((a, c) => a + num(c.valor), 0);

            document.getElementById('dash-km').innerText = km + " km";
            document.getElementById('dash-faturamento').innerText = "R$ " + faturamento.toFixed(2);
            document.getElementById('dash-estimado-oleo').innerText = "R$ " + totalAbastec.toFixed(2);
            document.getElementById('dash-despesas').innerText = "R$ " + gastos.toFixed(2);
            document.getElementById('dash-lucro').innerText = "R$ " + (faturamento - totalAbastec - gastos).toFixed(2);

            document.getElementById('lista-viagens').innerHTML = viagens.map(v => `
                <tr class="border-b">
                    <td class="p-3">${formatarData(v.data)}</td>
                    <td class="p-3"><b>${v.veiculo}</b><br>${v.origem} -> ${v.destino}</td>
                    <td class="p-3 text-green-600 font-bold">R$ ${num(v.viagem).toFixed(2)}</td>
                </tr>`).join('');
            
            // Render alertas de manutenção simplificados para o PDF
            document.getElementById('painel-alertas').innerHTML = manu.slice(0, 5).map(m => `
                <div class="p-3 border rounded ${num(m.faltam) < 500 ? 'bg-red-100' : 'bg-green-100'}">
                    <b>${m.veiculo} - ${m.servico}</b>: Próxima em ${m.proxima_troca} km
                </div>`).join('');
        }

        function filtrarLista(lista) {
            const p = document.getElementById('filtro-periodo').value;
            let f = (lista || []).filter(i => veiculosSelecionados.includes(i.veiculo));
            return f;
        }

        function inicializarFiltros() {
            const vens = [...new Set(DB.veiculos.map(v => v.nome))];
            if(veiculosSelecionados.length === 0) veiculosSelecionados = vens;
            document.getElementById('container-checkboxes').innerHTML = vens.map(v => `
                <label class="checkbox-label ${veiculosSelecionados.includes(v)?'checked':''}" onclick="toggleVeiculo('${v}')">
                    ${v}
                </label>`).join('');
        }

        function toggleVeiculo(n) {
            veiculosSelecionados = veiculosSelecionados.includes(n) ? veiculosSelecionados.filter(x=>x!==n) : [...veiculosSelecionados, n];
            inicializarFiltros();
            renderizarTudo();
        }

        function mudarAba(id) {
            document.querySelectorAll('.content-section').forEach(e => e.classList.add('hidden'));
            document.getElementById('section-'+id).classList.remove('hidden');
        }

        function mostrarLoading(s, t) { document.getElementById('loading-overlay').classList.toggle('hidden', !s); }
        function fecharModal() { document.getElementById('modal-viagem').classList.add('hidden'); }

        carregarDadosDoGoogle();
    </script>
</body>
</html>
